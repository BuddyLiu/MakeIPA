#######################################################################################################
#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#                          ä¼ä¸šçº§é¡¹ç›®è‡ªåŠ¨åŒ–æ‰“åŒ…è„šæœ¬
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#
## å°†MakeIPA.shæ·»åŠ åˆ°é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹
## æ­¤è„šæœ¬é’ˆå¯¹ä¼ä¸šçº§é¡¹ç›®æ‰“åŒ…ï¼Œä¸ä¼šç¼–è¯‘é¡¹ç›®ï¼Œåœ¨æ‰“åŒ…å‰ç¡®è®¤é¡¹ç›®å·²ç»ç¼–è¯‘å®Œæˆç”Ÿæˆäº†â€XXX.appâ€œæ–‡ä»¶
## ä½¿ç”¨å‰éœ€è¦é…ç½®è¯¥è„šæœ¬éƒ¨åˆ†è·¯å¾„æ‰èƒ½æ­£ç¡®æ‰“åŒ…ï¼Œéœ€è¦ä¿®æ”¹çš„å­—æ®µæœ‰â€~~~~...~~~~â€œæ ‡è¯†
#
## Xcodeå¯ä¿®æ”¹.appæ–‡ä»¶çš„ç”Ÿæˆè·¯å¾„ï¼Œå…·ä½“æ–¹æ³•è¯·å‚è€ƒï¼ˆæ„Ÿè°¢â€èŠ±è€ğŸ¯â€œçš„è¿™ç¯‡æ–‡ç« ï¼‰ï¼š
## https://www.cnblogs.com/huahuahu/p/Xcode-bian-yi-geng-gai-Build-shu-chu-lu-jing.html
## é»˜è®¤ä½¿ç”¨Relativeæ¨¡å¼
#
## ä½¿ç”¨æ–¹æ³•ï¼ˆä¿è¯æ‰€æœ‰é…ç½®éƒ½å®Œå…¨æ­£ç¡®ï¼Œç¼–è¯‘é¡¹ç›®ç”Ÿæˆ.appæ–‡ä»¶ï¼‰ï¼š
## æ‰“å¼€â€ç»ˆç«¯â€œï¼Œåˆ‡æ¢åˆ°MakeIPA.shæ–‡ä»¶æ‰€åœ¨ç›®å½• æ‰§è¡Œâ€./MakeIPA.shâ€œ
#

#
########################################################################################################


# è·å–é¡¹ç›®åç§°ï¼Œè‡ªåŠ¨è·å–ï¼Œæ— éœ€ä¿®æ”¹
ProjectName=`find . -name *.xcodeproj | awk -F "[/.]" '{print $(NF-1)}'`

# è®¾ç½®é¡¹ç›®å…¨è·¯å¾„~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~éœ€è¦æ ¹æ®é¡¹ç›®ä¿®æ”¹
ProjectPath="/Users/XXX/$ProjectName"

# è®¾ç½®.appæ–‡ä»¶æ ¹è·¯å¾„~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Xcodeè®¾ç½®è·¯å¾„åä¸ç”¨ä¿®æ”¹ï¼Œå¦‚æœªè®¾ç½®éœ€æ‰‹åŠ¨è·å–è·¯å¾„å¡«å†™åœ¨ä¸‹é¢
AppPath="$ProjectPath/DerivedData"

# .appæ–‡ä»¶å…¨è·¯å¾„ï¼Œè‡ªåŠ¨è·å–ï¼Œæ— éœ€ä¿®æ”¹
AppFilePath="$AppPath/$ProjectName/Build/Products/Release-iphoneos/$ProjectName.app"

# è®¾ç½®BundleId~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~éœ€è¦æ ¹æ®é¡¹ç›®ä¿®æ”¹
BundleId="com.xxx.xxx"

# æ—¶é—´ï¼Œè‡ªåŠ¨ç”Ÿæˆï¼Œæ— éœ€ä¿®æ”¹
Day=`date '+%m-%d'`
Time=`date '+%H%M%S'`

# Info.plistæ–‡ä»¶è·¯å¾„ï¼Œè‡ªåŠ¨è·å–ï¼Œæ— éœ€ä¿®æ”¹
InfoPlistPath="$ProjectPath/$ProjectName/Info.plist"

# è·å–ç‰ˆæœ¬å·,æ„å»ºç‰ˆæœ¬å·ï¼Œè‡ªåŠ¨è·å–ï¼Œæ— éœ€ä¿®æ”¹
BundleVersion=`/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" $InfoPlistPath`
BundleBuildVersion=`/usr/libexec/PlistBuddy -c "Print CFBundleVersion" $InfoPlistPath`

# è®¾ç½®.ipaæ–‡ä»¶ç›®å½•~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~é»˜è®¤æ”¾åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼Œå¯æŒ‰éœ€ä¿®æ”¹
IpaFilePath="$ProjectPath/$Day"

# è®¾ç½®.ipaæ–‡ä»¶å~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~é»˜è®¤æ˜¯æ—¶é—´åŠ åŒ…ååŠ ç‰ˆæœ¬å·åŠ æ„å»ºç‰ˆæœ¬å·ï¼Œå¯æŒ‰éœ€ä¿®æ”¹
IpaFileName="$Time-$BundleId-V$BundleVersion-B$BundleBuildVersion.ipa"

# ä¸Šé¢å®šä¹‰äº†å¸¸é‡
################################################################################################################################################
# ä¸‹é¢æ‰§è¡Œæ‰“åŒ…å‘½ä»¤

# æŒ‡å®šè¾“å‡ºæ–‡ä»¶ç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º
if [ -d "$IpaFilePath" ] ; then
echo $IpaFilePath
else
mkdir -pv $IpaFilePath
fi

#æ‰§è¡Œæ‰“åŒ…å‘½ä»¤
xcrun -sdk iphoneos  PackageApplication \
-v \
$AppFilePath \
-o \
$IpaFilePath/$IpaFileName

# æ‰“å¼€ç”Ÿæˆçš„ipaæ–‡ä»¶ç›®å½•
open $IpaFilePath/
